let INDEX_THRESHOLD=32767,topics,index,messageBus;class InternalMessageBus{constructor(){topics={},index=0}subscribe(s,t,i=null){if(s){if("function"!=typeof t)throw console.error("Topic "+s+" encountered error with callback: "),console.log(t),"callback must be a function";topics.hasOwnProperty(s)||(topics[s]={});let e=index.toString();return topics[s][e]={callback:t,target:i},++index>INDEX_THRESHOLD&&console.warn(`WARNING: Subscriber threshold reached for topic ${s}!`),{unsubscribe:function(){delete topics[s][e]},topic:s}}console.error("Undefined subscription topic for callback: "),console.error(t)}publish(e,s=0){var t=[];if(topics.hasOwnProperty(e)){var i,a=topics[e],o=[];for(let e=1;e<arguments.length;e++)o.push(arguments[e]);for(i in a)try{var r=a[i];r.callback.apply(r.target,o)}catch(e){t.push(e)}if(0<t.length)for(let e=0;e<t.length;e++)console.error(t[e])}}destroy(){topics={},index=0}}messageBus=new InternalMessageBus;class DialogManager{constructor(){this.reset(),messageBus.subscribe("gotoDialogNode",this.showDialogNode.bind(this))}addDialogNode(e,s){this.dialogNodes[e]?console.warn("Duplicate node: ",e):this.dialogNodes[e]=s}showDialogNode(e,s){this.hideDialogNode(),s?this.dialogNodes[e].showIdx(s):this.dialogNodes[e].show(),this.currNode=e}hideDialogNode(){null!==this.currNode&&(this.dialogNodes[this.currNode].hide(),this.currNode=null)}reset(){this.dialogNodes={},this.currNode=null}}dialogManager=new DialogManager;class DialogNode{constructor(e){this.nodeName=null,this.dialogData=e=e||[{speaker:"(Me):",text:"..."}],this.currTextIdx=0,this.branches=this.dialogData.branches,this.speech=this.dialogData.speech}show(){this.currTextIdx=0,messageBus.publish("showTalkText",this.speech[0].text,this.speech[0].instant),messageBus.publish("showTalkSpeaker",this.speech[0].speaker),this.speech[0].size&&messageBus.publish("updateTextSize",this.speech[0].size),this.speech[0].forceProgress&&messageBus.publish("forceTextProgress"),this.speech[0].unclickable&&messageBus.publish("unclickable"),this.speech[0].data&&(gameState[this.speech[0].data.property]=this.speech[0].data.value),this.speech[0].face&&messageBus.publish("showTalkFace",this.speech[0].face),this.speech[0].onStart&&this.speech[0].onStart(),this.speech[0].publish&&messageBus.publish(this.speech[0].publish,this.speech[0].param),0<this.speech.length&&messageBus.publish("showNextButton",this.showNext.bind(this)),this.hasBranches()&&1==this.speech.length&&this.setupBranches()}showIdx(e=0){this.currTextIdx=e,messageBus.publish("showTalkText",this.speech[this.currTextIdx].text,this.speech[this.currTextIdx].instant),messageBus.publish("showTalkSpeaker",this.speech[this.currTextIdx].speaker),this.speech[this.currTextIdx].size&&messageBus.publish("updateTextSize",this.speech[this.currTextIdx].size),this.speech[this.currTextIdx].forceProgress&&messageBus.publish("forceTextProgress"),this.speech[this.currTextIdx].unclickable&&messageBus.publish("unclickable"),this.speech[this.currTextIdx].data&&(gameState[this.speech[this.currTextIdx].data.property]=this.speech[this.currTextIdx].data.value),this.speech[this.currTextIdx].face&&messageBus.publish("showTalkFace",this.speech[this.currTextIdx].face),this.speech[this.currTextIdx].publish&&"savePoint"!==this.speech[this.currTextIdx].publish&&messageBus.publish(this.speech[this.currTextIdx].publish,this.speech[this.currTextIdx].param),this.speech[this.currTextIdx+1]||this.hasBranches()&&this.setupBranches()}showNext(){let e=!1;this.currTextIdx++;var s=this.speech[this.currTextIdx];if(s){if(s.dependentState&&!gameState[s.dependentState])return void this.showNext();if(s.rejectState&&gameState[s.rejectState])return void this.showNext();messageBus.publish("showTalkText",s.text,s.instant),messageBus.publish("showTalkSpeaker",s.speaker),s.size&&messageBus.publish("updateTextSize",s.size),s.forceProgress&&messageBus.publish("forceTextProgress"),s.unclickable&&messageBus.publish("unclickable"),s.face&&messageBus.publish("showTalkFace",s.face),s.onStart&&s.onStart(),s.publish&&messageBus.publish(s.publish,s.param),s.data&&(void 0!==s.data.value?gameState[s.data.property]=s.data.value:0<gameState[s.data.property]?gameState[s.data.property]+=1:gameState[s.data.property]=1),this.speech[this.currTextIdx+1]||this.hasBranches()&&(e=!0,this.setupBranches(this.speech[this.currTextIdx].onFinish))}else this.hasBranches()?e=!0:(messageBus.publish("hideAllDialog"),messageBus.publish("hideUndoPoint"));this.speech[this.currTextIdx-1]&&this.speech[this.currTextIdx-1].onFinish&&this.speech[this.currTextIdx-1].onFinish(),e&&(this.currTextIdx=0)}hide(){messageBus.publish("clearBranchOptions"),messageBus.publish("hideAllDialog")}setTargetNode(e){this.targetNode=e}hasBranches(){return this.branches&&0<this.branches.length}setupBranches(e){messageBus.publish("setBranches",this.branches,e)}}class InternalMouseManager{constructor(){}onPointerDown(e){gameVars.wasTouch=e.wasTouch,gameVars.mousedown=!0,gameVars.mouseJustDowned=!0;e=mouseToHand(e.x,e.y);gameVars.mouseposx=e.x,gameVars.mouseposy=e.y,gameVars.lastmousedown.x=e.x,gameVars.lastmousedown.y=e.y,messageBus.publish("pointerDown",e.x,e.y)}onPointerMove(e){gameVars.wasTouch=e.wasTouch;e=mouseToHand(e.x,e.y);gameVars.mouseposx=e.x,gameVars.mouseposy=e.y,messageBus.publish("pointerMove",e.x,e.y)}onPointerUp(e){gameVars.wasTouch=e.wasTouch,gameVars.mousedown=!1,gameVars.mouseJustUpped=!0;e=mouseToHand(e.x,e.y);gameVars.mouseposx=e.x,gameVars.mouseposy=e.y,messageBus.publish("pointerUp",e.x,e.y)}}function mouseToHand(e,s){gameConsts.halfWidth;e=gameConsts.halfWidth+gameConsts.halfWidth/+gameConsts.halfWidth*(e-gameConsts.halfWidth),s=gameConsts.halfHeight+gameConsts.halfHeight/+gameConsts.halfHeight*(s-gameConsts.halfHeight);return{x:Math.min(Math.max(0,e),gameConsts.width-1),y:Math.min(Math.max(0,s),gameConsts.height-1)}}function setupMouseInteraction(e){var s=e.make.image({x:0,y:0,key:"whitePixel",add:!0,scale:{x:20*gameConsts.width,y:10*gameConsts.height},alpha:.001});s.setInteractive(),s.on("pointerdown",mouseManager.onPointerDown,e),s.on("pointermove",mouseManager.onPointerMove,e),s.on("pointerup",mouseManager.onPointerUp,e)}mouseManager=new InternalMouseManager;let soundList=[];function initializeSounds(e){for(var s in audioFiles){s=audioFiles[s];soundList[s.name]&&console.warn("audio name duplicate ",s.name),soundList[s.name]=e.sound.add(s.name)}}function playSound(e,s=1,t=!1){return soundList[e].fullVolume=s,soundList[e].volume=s*globalVolume,soundList[e].loop=t,soundList[e].play(),soundList[e]}function updateGlobalVolume(e=1){for(var s in globalVolume=e,soundList)soundList[s].isPlaying&&(soundList[s].volume=soundList[s].fullVolume*globalVolume)}function tweenVolume(e,s,t=1500){return PhaserScene.tweens.timeline({targets:[soundList[e]],tweens:[{volume:s,duration:t}]})}let NORMAL="normal",HOVER="hover",PRESS="press",DISABLE="disable";class Button{constructor(e){this.scene=e.scene||PhaserScene,this.state=NORMAL,this.normal=e.normal,this.hover=e.hover||e.normal,this.press=e.press||e.normal,this.disable=e.disable||e.normal,this.onMouseDownFunc=e.onMouseDown,this.onMouseUpFunc=e.onMouseUp,this.onDragFunc=e.onDrag,this.onHoverFunc=e.onHover||null,this.onHoverOutFunc=e.onHoverOut||null,this.onDropFunc=e.onDrop||null,this.cursorInteractive=e.cursorInteractive,this.imageRefs={},this.oldImageRef=null,this.currImageRef=null,buttonManager.addToButtonList(this),this.handlePreload(),this.setState(NORMAL),this.isDraggable=e.isDraggable||!1,this.depth=0}setState(e){let s;switch(e){case NORMAL:s=this.normal;break;case HOVER:s=this.hover;break;case PRESS:s=this.press;break;case DISABLE:s=this.disable;break;default:return void console.error("Invalid state ",e)}if(this.state=e,s.ref){this.oldImageRef=this.currImageRef,this.currImageRef=s.ref,this.imageRefs[this.oldImageRef]&&(this.imageRefs[this.oldImageRef].visible=!1);let e=this.imageRefs[s.ref];var t;e||(e=s.atlas?this.scene.add.sprite(0,0,s.atlas,s.ref):this.scene.add.sprite(0,0,s.ref),(t=this.imageRefs[this.oldImageRef])&&(e.setOrigin(t.originX,t.originY),e.scrollFactorX=t.scrollFactorX,e.scrollFactorY=t.scrollFactorY),e.setDepth(this.depth),this.imageRefs[s.ref]=e),e.visible=!0}else s.ref=this.normal.ref;let i=this.imageRefs[this.oldImageRef];i=i||this.imageRefs[this.currImageRef],void 0===s.x?this.imageRefs[s.ref].x=i.x||0:this.imageRefs[s.ref].x=s.x,void 0===s.y?this.imageRefs[s.ref].y=i.y||0:this.imageRefs[s.ref].y=s.y,void 0===s.alpha?this.imageRefs[s.ref].alpha=i.alpha||1:this.imageRefs[s.ref].alpha=s.alpha,void 0===s.scaleX?this.imageRefs[s.ref].scaleX=i.scaleX||1:this.imageRefs[s.ref].scaleX=s.scaleX,void 0===s.scaleY?this.imageRefs[s.ref].scaleY=i.scaleY||1:this.imageRefs[s.ref].scaleY=s.scaleY,void 0!==s.origin&&this.setOrigin(origin.x,origin.y),void 0===s.tint?this.imageRefs[s.ref].setTint(i.tint):this.imageRefs[s.ref].setTint(s.tint)}checkCoordOver(e,s){var t,i,a,o;return this.state!==DISABLE&&(t=void 0!==this.normal.scrollFactorX?this.normal.scrollFactorX:1,o=void 0!==this.normal.scrollFactorY?this.normal.scrollFactorY:1,e=e+PhaserScene.cameras.main.scrollX*t,t=s+PhaserScene.cameras.main.scrollY*o,o=(s=this.imageRefs[this.currImageRef]).width*Math.abs(s.scaleX),i=s.height*Math.abs(s.scaleY),a=s.x-s.originX*o,o=s.x+(1-s.originX)*o,!(e<a||o<e||(a=s.y-s.originY*i,o=s.y+(1-s.originY)*i,t<a)||o<t))}onHover(){this.state===NORMAL&&this.setState(HOVER),this.onHoverFunc&&this.onHoverFunc()}onHoverOut(){this.onHoverOutFunc&&this.onHoverOutFunc(),this.setState(NORMAL)}onMouseDown(){var e;this.state!==DISABLE&&(this.setState(PRESS),this.onMouseDownFunc&&this.onMouseDownFunc(),this.isDraggable)&&!this.isDragged&&(this.setPos(gameVars.mouseposx+PhaserScene.cameras.main.scrollX,gameVars.mouseposy+PhaserScene.cameras.main.scrollY),this.isDragged=!0,(e=buttonManager.getDraggedObj())&&e.onDrop().bind(),buttonManager.setDraggedObj(this))}onDrag(){this.onDragFunc&&this.onDragFunc()}onMouseUp(){this.state===PRESS&&(this.setState(HOVER),this.onMouseUpFunc)&&this.onMouseUpFunc()}onDrop(){this.isDragged=!1,buttonManager.setDraggedObj(),this.onDropFunc&&this.onDropFunc()}setDepth(e=0){for(var s in this.depth=e,this.imageRefs)this.imageRefs[s].setDepth(e)}setRotation(e){this.normal.rotation=e,this.hover.rotation=e,this.press.rotation=e,this.disable.rotation=e}getPosX(){return this.getXPos()}getPosY(){return this.getYPos()}getScaleX(){return this.imageRefs[this.currImageRef].scaleX}getScaleY(){return this.imageRefs[this.currImageRef].scaleY}getXPos(){return this.normal.x}getYPos(){return this.normal.y}getWidth(){return this.imageRefs[this.currImageRef].width*this.imageRefs[this.currImageRef].scaleX}getHeight(){return this.imageRefs[this.currImageRef].height*this.imageRefs[this.currImageRef].scaleY}getState(){return this.state}getIsDragged(){return this.isDragged&&this.state!==DISABLE}getIsInteracted(){return this.state===HOVER||this.isDragged||this.state===PRESS}getIsHovered(){return this.state===HOVER}setOnMouseDownFunc(e){this.onMouseDownFunc=e}setOnMouseUpFunc(e){this.onMouseUpFunc=e}setOnHoverFunc(e){this.onHover=e}setOnHoverOutFunc(e){this.onHoverOutFunc=e}setNormalRef(e){this.normal.ref=e,this.state===NORMAL&&this.setState(NORMAL)}setHoverRef(e){this.hover.ref=e,this.state===HOVER&&this.setState(HOVER)}setHoverAlpha(e){this.hover.alpha=e}setPressRef(e){this.press.ref=e,this.state===PRESS&&this.setState(PRESS)}setDisableRef(e){this.disable.ref=e,this.state===DISABLE&&this.setState(DISABLE)}setAllRef(e){this.normal.ref=e,this.hover.ref=e,this.press.ref=e,this.disable.ref=e,this.setState(this.state)}setPos(e,s){if(void 0!==e)for(var t in this.normal.x=e,this.hover.x=e,this.press.x=e,this.disable.x=e,this.imageRefs)this.imageRefs[t].x=e;if(void 0!==s)for(var i in this.normal.y=s,this.hover.y=s,this.press.y=s,this.disable.y=s,this.imageRefs)this.imageRefs[i].y=s}setScrollFactor(e,s){if(void 0!==e)for(var t in this.normal.scrollFactorX=e,this.hover.scrollFactorX=e,this.press.scrollFactorX=e,this.disable.scrollFactorX=e,this.imageRefs)this.imageRefs[t].scrollFactorX=e;if(void 0!==s)for(var i in this.normal.scrollFactorY=s,this.hover.scrollFactorY=s,this.press.scrollFactorY=s,this.disable.scrollFactorY=s,this.imageRefs)this.imageRefs[i].scrollFactorY=s}setAlpha(e=1){for(var s in this.imageRefs)this.imageRefs[s].alpha=e}setScale(e,s){for(var t in void 0===s&&(s=e),this.imageRefs)this.imageRefs[t].scaleX=e,this.imageRefs[t].scaleY=s}bringToTop(){}setOrigin(e,s){for(var t in this.imageRefs)this.imageRefs[t].setOrigin(e,s)}tweenToPos(e,s,t,i,a){i={targets:this.imageRefs[this.currImageRef],ease:i,duration:t,onUpdate:a,onComplete:()=>{this.setPos(e,s)}};void 0!==e&&(i.x=e),void 0!==s&&(i.y=s),this.scene.tweens.add(i)}tweenToScale(e,s,t,i,a,o){i={targets:this.imageRefs[this.currImageRef],ease:i,duration:t,onUpdate:a,onComplete:()=>{this.setScale(e,s),o&&o()}};void 0!==e&&(i.scaleX=e),void 0!==s&&(i.scaleY=s),this.scene.tweens.add(i)}tweenToAlpha(e,s,t,i){t={targets:this.imageRefs[this.currImageRef],ease:t,duration:s,alpha:e,onComplete:()=>{this.setAlpha(e),i&&i()}};this.scene.tweens.add(t)}handlePreload(){this.hover.preload&&this.setState(HOVER),this.press.preload&&this.setState(PRESS),this.disable.preload&&this.setState(DISABLE)}destroy(){for(var e in buttonManager.removeButton(this),this.imageRefs)this.imageRefs[e].destroy()}}class InternalButtonManager{constructor(){this.buttonList=[],this.lastHovered=null,this.lastClickedButton=null,this.draggedObj=null,this.active=!0,this.updateInterval=25,this.updateCounter=0,messageBus.subscribe("pointerUp",this.onPointerUp.bind(this)),messageBus.subscribe("pointerMove",this.onPointerMove.bind(this)),messageBus.subscribe("pointerDown",this.onPointerDown.bind(this))}update(e){if(this.active){var t=gameVars.mouseposx,i=gameVars.mouseposy;let s=null;for(let e=this.buttonList.length-1;0<=e;e--){var a=this.buttonList[e];if(a&&a.checkCoordOver(t,i)){a.onHover(),s=a;break}}this.lastHovered&&this.lastHovered!==s&&"disable"!==this.lastHovered.getState()&&(this.lastHovered.setState("normal"),this.lastHovered.onHoverOut()),this.lastHovered=s}}onPointerUp(e,s){var t;this.active&&((t=this.getLastClickedButton())&&t.checkCoordOver(e,s)&&t.onMouseUp(),this.draggedObj)&&(this.draggedObj.onDrop&&this.draggedObj.onDrop(),this.draggedObj=null)}onPointerMove(e,s){this.active&&this.draggedObj&&(this.draggedObj.setPos(e+PhaserScene.cameras.main.scrollX,s+PhaserScene.cameras.main.scrollY),this.draggedObj.onDrag())}onPointerDown(s,t){if(this.active)for(let e=this.buttonList.length-1;0<=e;e--){var i=this.buttonList[e];if(i.checkCoordOver(s,t)){i.onMouseDown(),this.lastClickedButton=i;break}}}disableAllInput(){this.active=!1}enableAllInput(){this.active=!0}addToButtonList(e){this.buttonList.push(e)}getLastClickedButton(){return this.lastClickedButton}removeButton(e){for(var s in this.buttonList)if(this.buttonList[s]===e){this.buttonList.splice(parseInt(s),1);break}}bringToTop(e){this.removeButton(e),this.addToButtonList(e)}getDraggedObj(){return this.draggedObj}setDraggedObj(e=null){this.draggedObj=e}}buttonManager=new InternalButtonManager,helperFunction={runFunctionOverIntervals:function(s,t=[],i=0){if(0<t.length){let e=t[0];var a=e.delay+i;i=e.duration||0,setTimeout(()=>{s(e),t.shift(),helperFunction.runFunctionOverIntervals(s,t,i)},a)}},setShake:function(e){PhaserScene.cameras.main.shakeAmt=e,PhaserScene.cameras.main.xAway||(PhaserScene.cameras.main.xAway=0,PhaserScene.cameras.main.yAway=0)},scrollTo:function(e,s=0){PhaserScene.cameras.main.xAway=PhaserScene.cameras.main.scrollX-e,PhaserScene.cameras.main.yAway=PhaserScene.cameras.main.scrollY-s},screenShake:function(){PhaserScene.tweens.add({targets:[PhaserScene.cameras.main],scrollX:"+=6",scrollX:"+=1",ease:"Cubic.easeOut",duration:40,onComplete:()=>{PhaserScene.tweens.add({targets:[PhaserScene.cameras.main],scrollX:"-=9",scrollY:"-=3",ease:"Cubic.easeInOut",duration:75,onComplete:()=>{PhaserScene.tweens.add({targets:[PhaserScene.cameras.main],scrollX:"+=5",scrollY:"+=2",ease:"Cubic.easeInOut",duration:110,onComplete:()=>{PhaserScene.tweens.add({targets:[PhaserScene.cameras.main],scrollX:"-=2",scrollY:"-=1",ease:"Cubic.easeInOut",duration:130})}})}})}})},destroyList:function(s){for(let e=0;e<s.length;e++)s[e]&&s[e].destroy&&s[e].destroy()}};class InternalPoolManager{constructor(){this.poolList={}}getItemFromPool(e){let s=void 0;return null==this.poolList[e]&&(this.poolList[e]=[]),0<this.poolList[e].length&&((s=this.poolList[e].pop()).visible=!0),s}returnItemToPool(e,s){console.log("return item"),console.log(e),null==this.poolList[s]&&(this.poolList[s]=[]),this.poolList[s].push(e),e.visible=!1}}poolManager=new InternalPoolManager;class UpdateManager{constructor(){this.listOfFunctions=[]}update(s){for(let e=0;e<this.listOfFunctions.length;e++)this.listOfFunctions[e](s)}addFunction(s){for(let e=0;e<this.listOfFunctions.length;e++)if(s===this.listOfFunctions[e])return s;return this.listOfFunctions.push(s),s}removeFunction(s){for(let e=0;e<this.listOfFunctions.length;e++)s===this.listOfFunctions[e]&&this.listOfFunctions.splice(e,1)}removeAllFunctions(){this.listOfFunctions=[]}}updateManager=new UpdateManager;